<meta http-equiv="Content-Type" content="text/html">
<style type="text/css">body { margin-left:0;margin-right:0;margin-top:0; }#google-cache-hdr {background:#f5f5f5 !important;font:13px arial,sans-serif !important;text-align:left !important;color:#202020 !important;border:0 !important;margin:0 !important;border-bottom:1px solid #cecece !important;line-height:16px !important ;padding:16px 28px 24px 28px !important;}#google-cache-hdr * {display:inline !important;font:inherit !important;text-align:inherit !important;color:inherit !important;line-height:inherit !important;background:none !important;border:0 !important;margin:0 !important;padding:0 !important;letter-spacing:0 !important;}#google-cache-hdr a {text-decoration:none !important;color:#1a0dab !important;}#google-cache-hdr a:hover { text-decoration:underline !important; }#google-cache-hdr a:visited { color:#609 !important; }#google-cache-hdr div { display:block !important;margin-top:4px !important; }#google-cache-hdr b {font-weight:bold !important;display:inline-block !important;direction:ltr !important;}pre { word-wrap:break-word; }pre { white-space:pre-wrap; }</style><div id="google-cache-hdr"  dir=ltr><div>This is the html version of the file <a href="http://www.namikilab.tuat.ac.jp/~sasada/prog/Rava.pdf" dir="ltr">http://www.namikilab.tuat.ac.jp/~sasada/prog/Rava.pdf</a>.<br><b>Google</b> automatically generates html versions of documents as we crawl the web.</div></div><div style="position:relative;margin:8px;">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="CreationDate" content="D:20030618171103+09&#39;00&#39;">
<meta name="ModDate" content="D:20030618171103+09&#39;00&#39;">
<meta name="Producer" content="Acrobat Distiller 5.0.1 for Macintosh">
<meta name="Author" content="sd">
<meta name="Creator" content="QuarkXPresst 4.10r2: AdobePS 8.5.2">
<meta name="Title" content="Rava">
<title>はじめに</title>
</head><body  bgcolor=#ffffff vlink="blue" link="blue">
<table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=1><b>Page 1</b></a></font></td></tr></table><font size=3 color="#231f20" face="Times"><span style="font-size:10px;font-family:Times;color:#231f20">
<div style="position:absolute;top:698;left:149"><nobr><b>本稿ではJava仮想マシン（以下JVM）のしくみに</b></nobr></div>
<div style="position:absolute;top:720;left:137"><nobr><b>ついて紹介します．ただ紹介するだけではつまらない</b></nobr></div>
<div style="position:absolute;top:742;left:137"><nobr><b>ので，プログラミング言語Ruby<font style="font-size:5px">［1］</font>で実装したJVM</b></nobr></div>
<div style="position:absolute;top:764;left:137"><nobr><b>であるRava<font style="font-size:5px">［2］</font>の解説を交えながら進めていきます．</b></nobr></div>
<div style="position:absolute;top:787;left:137"><nobr><b>本稿は，Javaプログラムが実際にどうやってJVM上</b></nobr></div>
<div style="position:absolute;top:809;left:137"><nobr><b>で動いているのか疑問に思っている方を対象にしてい</b></nobr></div>
<div style="position:absolute;top:831;left:137"><nobr><b>るため，ある程度Javaプログラムを書くことができる</b></nobr></div>
<div style="position:absolute;top:853;left:137"><nobr><b>ということを前提としています<font style="font-size:5px">注1</font>．</b></nobr></div>
<div style="position:absolute;top:875;left:149"><nobr><b>なお，本稿はJVMの詳細な仕様や実装までは述べ</b></nobr></div>
<div style="position:absolute;top:898;left:137"><nobr><b>ません．そのため，自分でJVMを作ってみようという</b></nobr></div>
<div style="position:absolute;top:920;left:137"><nobr><b>方は，必ず『Java仮想マシン仕様』<font style="font-size:5px">［3］</font>を参照してく</b></nobr></div>
<div style="position:absolute;top:942;left:137"><nobr><b>ださい（英語では全文オンラインで読めます<font style="font-size:5px">［4］</font>）．</b></nobr></div>
<div style="position:absolute;top:964;left:137"><nobr><b>JVMを作ろうとまでは思わない方も，JVMの仕様を</b></nobr></div>
<div style="position:absolute;top:986;left:137"><nobr><b>勉強することでJavaについての理解が深まると思うの</b></nobr></div>
<div style="position:absolute;top:631;left:450"><nobr><b>でおすすめです．本稿も基本的にこの仕様に基づいて</b></nobr></div>
<div style="position:absolute;top:653;left:450"><nobr><b>説明します．また，村山敏清さんが以前本誌で連載</b></nobr></div>
<div style="position:absolute;top:676;left:450"><nobr><b>していたJVMの解説記事<font style="font-size:5px">［5］</font>を含めた，組み込みJava</b></nobr></div>
<div style="position:absolute;top:698;left:450"><nobr><b>の情報をWeb上で公開<font style="font-size:5px">［6］</font>されていますので，そちら</b></nobr></div>
<div style="position:absolute;top:720;left:450"><nobr><b>もぜひ参考にしてください．</b></nobr></div>
<div style="position:absolute;top:787;left:462"><nobr><b>ご存知のとおり，Javaプログラムを実行するために</b></nobr></div>
<div style="position:absolute;top:809;left:450"><nobr><b>は，だいたい図1のような実行手順を踏みます．</b></nobr></div>
<div style="position:absolute;top:831;left:462"><nobr><b>Javaで記述されたソースプログラムは，Javaバイト</b></nobr></div>
<div style="position:absolute;top:853;left:450"><nobr><b>コードコンパイラ（javacなど）でコンパイルすること</b></nobr></div>
<div style="position:absolute;top:875;left:450"><nobr><b>により，クラスファイルへと変換されます．そして，</b></nobr></div>
<div style="position:absolute;top:898;left:450"><nobr><b>クラスファイルのとおりにJVMは動作します．JVM</b></nobr></div>
<div style="position:absolute;top:920;left:450"><nobr><b>はクラスファイルのみを相手にするため，Java以外の</b></nobr></div>
<div style="position:absolute;top:942;left:450"><nobr><b>言語で記述されたプログラムでも，それを適切にバイ</b></nobr></div>
<div style="position:absolute;top:964;left:450"><nobr><b>トコードへ変換するコンパイラさえあれば，JVM上で</b></nobr></div>
<div style="position:absolute;top:986;left:450"><nobr><b>実行することが可能です．</b></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:1298;left:91"><nobr><b>158 </b><font style="font-size:10px">●</font><i><b><font style="font-size:8px">JAVA PRESS Vol.31</font></b></i></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:650;left:140"><nobr>はじめに</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:751;left:453"><nobr>★Javaプログラムはどう動く？</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:1256;left:137"><nobr>注1 偉そうなこと書いてますが，きっと私より皆さんのほうがJava得意だと思います．</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:6px;font-family:Times">
<div style="position:absolute;top:1048;left:549"><nobr>Javaソースコード</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:1096;left:532"><nobr>バイトコードコンパイラ</nobr></div>
<div style="position:absolute;top:1108;left:553"><nobr>（javac，etc）</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:6px;font-family:Times">
<div style="position:absolute;top:1156;left:553"><nobr>クラスファイル</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:1210;left:550"><nobr>Java仮想マシン</nobr></div>
<div style="position:absolute;top:1186;left:586"><nobr>［実行］</nobr></div>
<div style="position:absolute;top:1079;left:586"><nobr>［コンパイル］</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:1020;left:509"><nobr>●図1 Javaプログラムが動くまで</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:1028;left:140"><nobr>"Q <b><font style="font-size:10px">参考文献</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:1052;left:135"><nobr>［1］オブジェクト指向言語Ruby：http://www.ruby-lang.org/ja/</nobr></div>
<div style="position:absolute;top:1067;left:135"><nobr>［2］Rava / JavaVM on Ruby</nobr></div>
<div style="position:absolute;top:1067;left:285"><nobr>JP サポート用： http://www.</nobr></div>
<div style="position:absolute;top:1082;left:157"><nobr>namikilab.tuat.ac.jp/~sasada/prog/rava_jp.html</nobr></div>
<div style="position:absolute;top:1097;left:135"><nobr>［3］『Java仮想マシン仕様第2版』／ティム・リンドホルム，フ</nobr></div>
<div style="position:absolute;top:1112;left:157"><nobr>ランク・イェリン著／村上雅章訳／ピアソン・エデュケーシ</nobr></div>
<div style="position:absolute;top:1127;left:157"><nobr>ョン 2001</nobr></div>
<div style="position:absolute;top:1142;left:135"><nobr>［4］The Java Virtual Machine Specification：http://java.sun.</nobr></div>
<div style="position:absolute;top:1157;left:157"><nobr>com/docs/books/vmspec/</nobr></div>
<div style="position:absolute;top:1172;left:135"><nobr>［5］「Java 仮想マシン入門」／村山敏清著／『JAVA PRESS』</nobr></div>
<div style="position:absolute;top:1187;left:157"><nobr>Vol.14?23連載／技術評論社</nobr></div>
<div style="position:absolute;top:1202;left:135"><nobr>［6］組込み Java 情報源： http://www.netgene.co.jp/java</nobr></div>
<div style="position:absolute;top:1217;left:157"><nobr>/index.html</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:219;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ158</nobr></div>
</span></font>

<div style="position:absolute;top:1438;left:0"><hr><table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=2><b>Page 2</b></a></font></td></tr></table></div><font size=3 color="#231f20" face="Times"><span style="font-size:10px;font-family:Times;color:#231f20">
<div style="position:absolute;top:1916;left:151"><nobr><b>そもそもなぜJVMが必要なのか，というのは使い古</b></nobr></div>
<div style="position:absolute;top:1939;left:139"><nobr><b>された説明で恐縮ですが，仮想マシンを実際の計算機</b></nobr></div>
<div style="position:absolute;top:1961;left:139"><nobr><b>システム上に被せることでハードウェアアーキテクチ</b></nobr></div>
<div style="position:absolute;top:1983;left:139"><nobr><b>ャやオペレーティングシステムなどから独立をはかる，</b></nobr></div>
<div style="position:absolute;top:2005;left:139"><nobr><b>つまり，どこでも一緒のプログラムを動かしたいとい</b></nobr></div>
<div style="position:absolute;top:2027;left:139"><nobr><b>う目的によります．また，JVM自体にセキュリティ機</b></nobr></div>
<div style="position:absolute;top:2050;left:139"><nobr><b>能をもたせることで実行の堅牢性を保証することがで</b></nobr></div>
<div style="position:absolute;top:2072;left:139"><nobr><b>きます．計算機システムにおいて，仮想マシンのよう</b></nobr></div>
<div style="position:absolute;top:2094;left:139"><nobr><b>な抽象層を1枚被せるとシステムは10倍遅くなる，と</b></nobr></div>
<div style="position:absolute;top:2116;left:139"><nobr><b>いうような話もあるそうですが，そのようなデメリッ</b></nobr></div>
<div style="position:absolute;top:2138;left:139"><nobr><b>トを差し引いても互換性や堅牢性が欲しかったわけで</b></nobr></div>
<div style="position:absolute;top:2161;left:139"><nobr><b>す．もちろんJVMの実装技術が発達すれば，プラッ</b></nobr></div>
<div style="position:absolute;top:2183;left:139"><nobr><b>トフォーム依存のプログラムの実行速度とのギャップ</b></nobr></div>
<div style="position:absolute;top:2205;left:139"><nobr><b>は縮まる（もしくは逆転する？）はずです．</b></nobr></div>
<div style="position:absolute;top:2272;left:151"><nobr><b>Ravaとは，すべてRubyで記述した，Ruby100%，</b></nobr></div>
<div style="position:absolute;top:2294;left:139"><nobr><b>まじりっ気なしのJava仮想マシンです<font style="font-size:5px">注2</font>．</b></nobr></div>
<div style="position:absolute;top:2316;left:151"><nobr><b>従来JVMはCやC++で実装されてきました．筆者</b></nobr></div>
<div style="position:absolute;top:2338;left:139"><nobr><b>の知る限りでは，ほかにはJavaでの実装<font style="font-size:5px">［7］</font>しかあり</b></nobr></div>
<div style="position:absolute;top:2360;left:139"><nobr><b>ません．その最大の理由は実行速度です．前述したと</b></nobr></div>
<div style="position:absolute;top:2383;left:139"><nobr><b>おり，JVMという抽象層があるためシステムの処理速</b></nobr></div>
<div style="position:absolute;top:2405;left:139"><nobr><b>度が遅くなってしまうので，できるだけ実行速度を速</b></nobr></div>
<div style="position:absolute;top:2427;left:139"><nobr><b>くするようなプログラミング言語が選ばれるわけです．</b></nobr></div>
<div style="position:absolute;top:2449;left:139"><nobr><b>Rubyはお世辞にも処理速度に優れた実行環境がある</b></nobr></div>
<div style="position:absolute;top:2471;left:139"><nobr><b>とは言えません．</b></nobr></div>
<div style="position:absolute;top:2494;left:151"><nobr><b>では，なぜRubyでRavaを作ったのか？その動機</b></nobr></div>
<div style="position:absolute;top:1916;left:452"><nobr><b>は，誰もやってなかったからです．作るのが楽しかっ</b></nobr></div>
<div style="position:absolute;top:1939;left:452"><nobr><b>たからです．結果としては，処理速度としてはやはり</b></nobr></div>
<div style="position:absolute;top:1961;left:452"><nobr><b>遅いものになりましたが，JVMの理解は深まったと思</b></nobr></div>
<div style="position:absolute;top:1983;left:452"><nobr><b>いますし，この記事を書かせてもらうこともできまし</b></nobr></div>
<div style="position:absolute;top:2005;left:452"><nobr><b>た．</b></nobr></div>
<div style="position:absolute;top:2027;left:464"><nobr><b>Ravaのシステムの全体像としては，図2のようにな</b></nobr></div>
<div style="position:absolute;top:2050;left:452"><nobr><b>ります．</b></nobr></div>
<div style="position:absolute;top:2116;left:464"><nobr><b>何はともあれ，Ravaを実際に動かしてみましょう．</b></nobr></div>
<div style="position:absolute;top:2138;left:452"><nobr><b>Ravaのインストール，セッティングについては本稿サ</b></nobr></div>
<div style="position:absolute;top:2161;left:452"><nobr><b>ポート用ページ<font style="font-size:5px">［2］</font>をご覧ください．</b></nobr></div>
<div style="position:absolute;top:2183;left:464"><nobr><b>セットアップが終了したら，UNIX系OSならばシ</b></nobr></div>
<div style="position:absolute;top:2205;left:452"><nobr><b>ェル，Windowsならばコマンドプロンプト上で</b>ruby</nobr></div>
<div style="position:absolute;top:2227;left:452"><nobr>rava.rb Counter<b>と入力してください．次のような</b></nobr></div>
<div style="position:absolute;top:2249;left:452"><nobr><b>出力が得られます．</b></nobr></div>
</span></font>
<font size=2 color="#231f20" face="Times"><span style="font-size:9px;font-family:Times;color:#231f20">
<div style="position:absolute;top:2284;left:452"><nobr>$ ruby rava.rb Counter</nobr></div>
<div style="position:absolute;top:2306;left:452"><nobr>init Counter</nobr></div>
<div style="position:absolute;top:2328;left:452"><nobr>init Counter</nobr></div>
<div style="position:absolute;top:2350;left:452"><nobr>init Counter2</nobr></div>
<div style="position:absolute;top:2372;left:452"><nobr>1</nobr></div>
<div style="position:absolute;top:2395;left:452"><nobr>extended add</nobr></div>
<div style="position:absolute;top:2417;left:452"><nobr>extended add</nobr></div>
<div style="position:absolute;top:2439;left:452"><nobr>5</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:2565;left:608"><nobr><i><b>JAVA PRESS Vol.31</b></i><font style="font-size:10px">● </font><b><font style="font-size:14px">159</font></b></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:2236;left:139"><nobr>★Ravaって何？</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:2522;left:139"><nobr>注2 まだまだ仕様を満たしてない部分もあるのですが．</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:2080;left:454"><nobr>★Ravaを実行してみる</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:2465;left:456"><nobr>"Q <b><font style="font-size:10px">参考文献</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:2489;left:451"><nobr>［7］Jalapen</nobr></div>
<div style="position:absolute;top:2479;left:504"><nobr>-</nobr></div>
<div style="position:absolute;top:2489;left:508"><nobr>o project：http://www.research.ibm.com/jalapeno/</nobr></div>
<div style="position:absolute;top:1671;left:274"><nobr>Rava</nobr></div>
<div style="position:absolute;top:1691;left:280"><nobr>Class</nobr></div>
<div style="position:absolute;top:1708;left:282"><nobr>Constant Pool</nobr></div>
<div style="position:absolute;top:1730;left:287"><nobr>Method Info</nobr></div>
<div style="position:absolute;top:1751;left:290"><nobr>Other Info</nobr></div>
<div style="position:absolute;top:1809;left:288"><nobr>Class Loader</nobr></div>
<div style="position:absolute;top:1692;left:408"><nobr>Bytecode</nobr></div>
<div style="position:absolute;top:1702;left:409"><nobr>Compiler</nobr></div>
<div style="position:absolute;top:1743;left:413"><nobr>Profiler</nobr></div>
<div style="position:absolute;top:1793;left:410"><nobr>Bytecode</nobr></div>
<div style="position:absolute;top:1803;left:408"><nobr>Interpreter</nobr></div>
<div style="position:absolute;top:1699;left:503"><nobr>Thread</nobr></div>
<div style="position:absolute;top:1720;left:506"><nobr>PC</nobr></div>
<div style="position:absolute;top:1719;left:540"><nobr>Method</nobr></div>
<div style="position:absolute;top:1751;left:512"><nobr>JVM Stack</nobr></div>
<div style="position:absolute;top:1769;left:522"><nobr>Frame</nobr></div>
<div style="position:absolute;top:1785;left:532"><nobr>…</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:1848;left:384"><nobr><b>Ruby Interpreter</b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:1876;left:293"><nobr>Class File</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:1648;left:253"><nobr>●図2 Ravaシステムの全体像</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:1482;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ159</nobr></div>
</span></font>

<div style="position:absolute;top:2701;left:0"><hr><table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=3><b>Page 3</b></a></font></td></tr></table></div><font size=3 color="#231f20" face="Times"><span style="font-size:10px;font-family:Times;color:#231f20">
<div style="position:absolute;top:2913;left:149"><nobr><b>サンプルに利用したクラスCounterおよびCounter2</b></nobr></div>
<div style="position:absolute;top:2935;left:137"><nobr><b>を記述したソースをリスト1に示します．サンプルは</b></nobr></div>
<div style="position:absolute;top:2957;left:137"><nobr><b>見てのとおりとても簡単なもので，クラス名にもやる</b></nobr></div>
<div style="position:absolute;top:2980;left:137"><nobr><b>気が感じられません．しかし，Ravaがこのサンプルく</b></nobr></div>
<div style="position:absolute;top:3002;left:137"><nobr><b>らいは実行可能であることを示しました．これくらい</b></nobr></div>
<div style="position:absolute;top:3024;left:137"><nobr><b>できなくてJVMを名乗るな，という気もします．</b></nobr></div>
<div style="position:absolute;top:3046;left:149"><nobr><b>なお，プログラム中の</b>rj.out()<b>メソッドは，Rava</b></nobr></div>
<div style="position:absolute;top:3068;left:137"><nobr><b>用のコンソール出力メソッドだと思ってください．ち</b></nobr></div>
<div style="position:absolute;top:2913;left:450"><nobr><b>なみに，Java 2 SDK（以下JDK）付属のJava環境で</b></nobr></div>
<div style="position:absolute;top:2935;left:450"><nobr>java Counter<b>のように実行しても，同様の出力を</b></nobr></div>
<div style="position:absolute;top:2957;left:450"><nobr><b>得ることができます．</b></nobr></div>
<div style="position:absolute;top:3046;left:462"><nobr><b>JVMがどのように動くのかを記述してあるのがクラ</b></nobr></div>
<div style="position:absolute;top:3068;left:450"><nobr><b>スファイルでした．ここでは，クラスファイルにはど</b></nobr></div>
<div style="position:absolute;top:3091;left:450"><nobr><b>んな情報が詰まっているかを概観します．</b></nobr></div>
<div style="position:absolute;top:3157;left:463"><nobr><b>とりあえずクラスファイルをエディタで開いてみる</b></nobr></div>
<div style="position:absolute;top:3179;left:450"><nobr><b>と，よくわからないデータの並びが表示されます．こ</b></nobr></div>
<div style="position:absolute;top:3202;left:450"><nobr><b>れはクラスファイルがバイナリデータであるためです．</b></nobr></div>
<div style="position:absolute;top:3224;left:450"><nobr><b>そこで，JDKに付属しているクラスファイルのディス</b></nobr></div>
<div style="position:absolute;top:3246;left:450"><nobr><b>アセンブラである</b>javap<b>コマンドを利用します．こ</b></nobr></div>
<div style="position:absolute;top:3268;left:450"><nobr><b>のコマンドはクラスファイルを人間が読める形にして</b></nobr></div>
<div style="position:absolute;top:3290;left:450"><nobr><b>くれます．</b></nobr></div>
<div style="position:absolute;top:3313;left:463"><nobr><b>では，Counterクラスのクラスファイルを覗いてみ</b></nobr></div>
<div style="position:absolute;top:3335;left:450"><nobr><b>ましょう．</b>javap -c Counter<b>と実行してみます</b></nobr></div>
<div style="position:absolute;top:3357;left:444"><nobr><b>（図3）．</b></nobr></div>
<div style="position:absolute;top:3379;left:462"><nobr>javap<b>コマンドによって，</b>О<b>Counterクラスに存在</b></nobr></div>
<div style="position:absolute;top:3401;left:450"><nobr><b>するメソッドやフィールド，</b>@<b>各メソッドの動作，な</b></nobr></div>
<div style="position:absolute;top:3424;left:450"><nobr><b>どがわかります．</b></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:3824;left:91"><nobr><b>160 </b><font style="font-size:10px">●</font><i><b><font style="font-size:8px">JAVA PRESS Vol.31</font></b></i></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:2999;left:455"><nobr>クラスファイル</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:3121;left:453"><nobr>★クラスファイルの中身を覗く</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:3132;left:139"><nobr>// Base Counter Class</nobr></div>
<div style="position:absolute;top:3143;left:139"><nobr>public class Counter{</nobr></div>
<div style="position:absolute;top:3153;left:158"><nobr>private int counter;</nobr></div>
<div style="position:absolute;top:3164;left:158"><nobr>public static void main(String[] args){</nobr></div>
<div style="position:absolute;top:3174;left:178"><nobr>Counter cnt  = new Counter();</nobr></div>
<div style="position:absolute;top:3174;left:338"><nobr>// オブジェクト生成</nobr></div>
<div style="position:absolute;top:3185;left:178"><nobr>Counter cnt2 = new Counter2();</nobr></div>
<div style="position:absolute;top:3206;left:178"><nobr>rj.out(cnt.add(1));</nobr></div>
<div style="position:absolute;top:3206;left:301"><nobr>// メソッド起動</nobr></div>
<div style="position:absolute;top:3216;left:178"><nobr>cnt2.add(2);    </nobr></div>
<div style="position:absolute;top:3216;left:301"><nobr>// 派生クラスメソッド起動</nobr></div>
<div style="position:absolute;top:3227;left:178"><nobr>cnt2.add(3);</nobr></div>
<div style="position:absolute;top:3237;left:178"><nobr>rj.out(cnt2.get());</nobr></div>
<div style="position:absolute;top:3237;left:301"><nobr>// 出力</nobr></div>
<div style="position:absolute;top:3248;left:158"><nobr>}</nobr></div>
<div style="position:absolute;top:3258;left:158"><nobr>Counter(){    </nobr></div>
<div style="position:absolute;top:3258;left:301"><nobr>// コンストラクタ</nobr></div>
<div style="position:absolute;top:3269;left:178"><nobr>counter = 0;</nobr></div>
<div style="position:absolute;top:3279;left:178"><nobr>rj.out(&quot;init Counter&quot;);</nobr></div>
<div style="position:absolute;top:3290;left:158"><nobr>}</nobr></div>
<div style="position:absolute;top:3300;left:158"><nobr>public int add(int a){</nobr></div>
<div style="position:absolute;top:3311;left:178"><nobr>for(int i=0;i&lt;a;i++){  // ローカル変数アクセス・計算</nobr></div>
<div style="position:absolute;top:3321;left:197"><nobr>counter++;    </nobr></div>
<div style="position:absolute;top:3321;left:301"><nobr>// フィールドアクセス・計算</nobr></div>
<div style="position:absolute;top:3332;left:178"><nobr>}</nobr></div>
<div style="position:absolute;top:3342;left:178"><nobr>return counter;</nobr></div>
<div style="position:absolute;top:3353;left:158"><nobr>}</nobr></div>
<div style="position:absolute;top:3363;left:158"><nobr>public int get(){</nobr></div>
<div style="position:absolute;top:3374;left:158"><nobr>return counter;</nobr></div>
<div style="position:absolute;top:3384;left:158"><nobr>}</nobr></div>
<div style="position:absolute;top:3395;left:139"><nobr>}</nobr></div>
<div style="position:absolute;top:3405;left:139"><nobr>// Extended Counter Class</nobr></div>
<div style="position:absolute;top:3416;left:139"><nobr>public class Counter2 extends Counter{</nobr></div>
<div style="position:absolute;top:3426;left:158"><nobr>Counter2(){    </nobr></div>
<div style="position:absolute;top:3426;left:301"><nobr>// 派生クラスコンストラクタ</nobr></div>
<div style="position:absolute;top:3437;left:178"><nobr>rj.out(&quot;init Counter2&quot;);</nobr></div>
<div style="position:absolute;top:3447;left:158"><nobr>}</nobr></div>
<div style="position:absolute;top:3458;left:158"><nobr>public int add(int a){</nobr></div>
<div style="position:absolute;top:3468;left:178"><nobr>rj.out(&quot;extended add&quot;);</nobr></div>
<div style="position:absolute;top:3479;left:178"><nobr>return super.add(a); </nobr></div>
<div style="position:absolute;top:3479;left:301"><nobr>// 基底クラスメソッド呼び出し</nobr></div>
<div style="position:absolute;top:3489;left:158"><nobr>}</nobr></div>
<div style="position:absolute;top:3500;left:139"><nobr>}</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:3113;left:137"><nobr>●リスト1 Counter.java</nobr></div>
</span></font>
<font size=2 color="#000000" face="Times"><span style="font-size:9px;font-family:Times;color:#000000">
<div style="position:absolute;top:3539;left:150"><nobr><b>Column<font color="#000000" style="font-size:12px">★プログラミング言語Ruby</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:3568;left:161"><nobr>プログラミング言語Ruby は，まつもとゆきひろさんに</nobr></div>
<div style="position:absolute;top:3588;left:150"><nobr>よってデザインされたオブジェクト指向なスクリプト言語で</nobr></div>
<div style="position:absolute;top:3607;left:150"><nobr>す．</nobr></div>
<div style="position:absolute;top:3627;left:161"><nobr>Rubyは本格的なオブジェクト指向言語であり，たとえ</nobr></div>
<div style="position:absolute;top:3646;left:150"><nobr>ばクラスやその派生などの概念は本誌読者の方には馴染み</nobr></div>
<div style="position:absolute;top:3666;left:150"><nobr>深いものであると思います．それに加え，Mix-inや特異メ</nobr></div>
<div style="position:absolute;top:3685;left:150"><nobr>ソッドなどをサポートしています．そして，Rubyはすべて</nobr></div>
<div style="position:absolute;top:3705;left:150"><nobr>がオブジェクトです．</nobr></div>
<div style="position:absolute;top:3724;left:161"><nobr>インタプリタであるため，コンパイルなどの作業を行わず</nobr></div>
<div style="position:absolute;top:3744;left:150"><nobr>にRubyスクリプトを実行することが可能です．また，テ</nobr></div>
<div style="position:absolute;top:3763;left:150"><nobr>キスト処理の能力にも優れており，Perlと同じくらい強力</nobr></div>
<div style="position:absolute;top:3568;left:444"><nobr>です．さらにシンプルな文法と，例外処理やイテレータな</nobr></div>
<div style="position:absolute;top:3588;left:444"><nobr>どの機構によって，よりわかりやすいプログラミングを可能</nobr></div>
<div style="position:absolute;top:3607;left:444"><nobr>にしています．その上，ガーベッジコレクタやスレッドなど</nobr></div>
<div style="position:absolute;top:3627;left:444"><nobr>を備えながら，移植性が高くさまざまなプラットフォームに</nobr></div>
<div style="position:absolute;top:3646;left:444"><nobr>移植されています．</nobr></div>
<div style="position:absolute;top:3666;left:455"><nobr>Ruby の文法を学習するためには俗にいうRuby 本<b><font style="font-size:5px">［8］</font></b></nobr></div>
<div style="position:absolute;top:3685;left:438"><nobr>（オススメ）どがあります．また，公式ページ<b><font style="font-size:5px">［1］</font></b>から日本</nobr></div>
<div style="position:absolute;top:3705;left:444"><nobr>語の有用なドキュメントが辿れます．</nobr></div>
<div style="position:absolute;top:3724;left:455"><nobr>本稿執筆時点（2003年6月）でのRubyのバージョ</nobr></div>
<div style="position:absolute;top:3744;left:444"><nobr>ンは，安定版が1.6.8 であり，次期安定版である 1.8.0</nobr></div>
<div style="position:absolute;top:3763;left:444"><nobr>のリリースを準備中という状況です．</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:3460;left:455"><nobr>"Q <b><font style="font-size:10px">参考文献</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:3483;left:450"><nobr>［8］『オブジェクト指向スクリプト言語 Ruby』／まつもとゆきひ</nobr></div>
<div style="position:absolute;top:3498;left:472"><nobr>ろ，石塚圭樹著／アスキー 1999</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:2745;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ160</nobr></div>
</span></font>

<div style="position:absolute;top:3964;left:0"><hr><table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=4><b>Page 4</b></a></font></td></tr></table></div><font size=3 color="#231f20" face="Times"><span style="font-size:10px;font-family:Times;color:#231f20">
<div style="position:absolute;top:4173;left:151"><nobr>@<b>はメソッド先頭からのオフセットとバイトコード，</b></nobr></div>
<div style="position:absolute;top:4198;left:139"><nobr><b>およびそのバイトコードに関する付加情報の並びとな</b></nobr></div>
<div style="position:absolute;top:4220;left:139"><nobr><b>っています．バイトコードとは仮想マシンであるJVM</b></nobr></div>
<div style="position:absolute;top:4243;left:139"><nobr><b>の命令のことです．たとえば，</b>add<b>メソッドが最初に</b></nobr></div>
<div style="position:absolute;top:4265;left:139"><nobr><b>実行する命令は</b>iconst_0<b>で，その次に</b>istore_2</nobr></div>
<div style="position:absolute;top:4287;left:139"><nobr><b>を実行する，という意味になります．</b></nobr></div>
<div style="position:absolute;top:4354;left:151"><nobr><b>では，クラスファイルの構造はどのようになってい</b></nobr></div>
<div style="position:absolute;top:4376;left:139"><nobr><b>るのでしょうか．JVM仕様<font style="font-size:5px">［3］</font>によると，Cライクな</b></nobr></div>
<div style="position:absolute;top:4398;left:139"><nobr><b>文法で表現した場合，リスト2のようになります．</b></nobr></div>
<div style="position:absolute;top:4420;left:151"><nobr><b>リスト中の</b>u1<b>，</b>u2<b>，</b>u4<b>はそれぞれビッグエンディ</b></nobr></div>
<div style="position:absolute;top:4442;left:139"><nobr><b>アンの符号無しの1，2，4バイト整数を表します．細</b></nobr></div>
<div style="position:absolute;top:4465;left:139"><nobr><b>かいところ，面白くないところは省略しますので，詳</b></nobr></div>
<div style="position:absolute;top:4487;left:139"><nobr><b>細はJVM仕様を確認してください．ちなみに，イン</b></nobr></div>
<div style="position:absolute;top:4509;left:139"><nobr><b>タフェースもクラスファイルによって表現されます．</b></nobr></div>
<div style="position:absolute;top:4531;left:139"><nobr><b>インタフェースの場合，</b>access_flags<b>にその旨が</b></nobr></div>
<div style="position:absolute;top:4553;left:139"><nobr><b>記録されます．</b></nobr></div>
<div style="position:absolute;top:4576;left:151"><nobr><b>まず，</b>magic<b>とはこのファイルがクラスファイルで</b></nobr></div>
<div style="position:absolute;top:4598;left:139"><nobr><b>あることを示す数値</b>0xCAFEBABE<b>という値です．お</b></nobr></div>
<div style="position:absolute;top:4620;left:139"><nobr><b>しゃれですね．</b></nobr></div>
<div style="position:absolute;top:4642;left:151"><nobr><b>コンパイル時に確定する定数や文字列などは，コン</b></nobr></div>
<div style="position:absolute;top:4176;left:452"><nobr><b>スタントプール（</b>constatn_pool<b>）に詰め込まれ</b></nobr></div>
<div style="position:absolute;top:4198;left:452"><nobr><b>ます．クラスファイルではいろいろなところからこの</b></nobr></div>
<div style="position:absolute;top:4220;left:452"><nobr><b>情報を利用します．たとえば，そのクラスと基底クラ</b></nobr></div>
<div style="position:absolute;top:4243;left:452"><nobr><b>スの情報を格納する</b>this_class<b>，</b>super_class</nobr></div>
<div style="position:absolute;top:4265;left:452"><nobr><b>は，実際はコンスタントプールのインデックスとして</b></nobr></div>
<div style="position:absolute;top:4287;left:452"><nobr><b>表現されます．</b></nobr></div>
<div style="position:absolute;top:4309;left:464"><nobr>methods<b>にはメソッドの数だけエントリがあり，そ</b></nobr></div>
<div style="position:absolute;top:4331;left:452"><nobr><b>れぞれのエントリが1つのメソッドの情報を格納して</b></nobr></div>
<div style="position:absolute;top:4354;left:452"><nobr><b>います．メソッドの情報にはそのメソッドがどのよう</b></nobr></div>
<div style="position:absolute;top:4376;left:452"><nobr><b>なバイトコード列を持つか，例外が発生した場合どう</b></nobr></div>
<div style="position:absolute;top:4398;left:452"><nobr><b>するか，などの情報が格納されています．</b></nobr></div>
<div style="position:absolute;top:4420;left:464"><nobr>fields<b>や</b>interfaces<b>も見ればわかりますね．</b></nobr></div>
<div style="position:absolute;top:4442;left:452"><nobr><b>どんなフィールドがあるか，どんなインタフェースが</b></nobr></div>
<div style="position:absolute;top:4465;left:452"><nobr><b>定義されているか，という情報です．</b></nobr></div>
<div style="position:absolute;top:4531;left:464"><nobr><b>やっとRavaの話です．Ravaはもちろん実行時にク</b></nobr></div>
<div style="position:absolute;top:4553;left:452"><nobr><b>ラスファイルをロードします．</b></nobr></div>
<div style="position:absolute;top:4576;left:464"><nobr><b>JVM仕様としては，クラスファイルが正しいもので</b></nobr></div>
<div style="position:absolute;top:4598;left:452"><nobr><b>あるかどうか，検査（Verify）しなければならず，そ</b></nobr></div>
<div style="position:absolute;top:4620;left:452"><nobr><b>の項目も決められています．これは悪意のあるものが</b></nobr></div>
<div style="position:absolute;top:4642;left:452"><nobr><b>クラスファイルを改竄してJVMが不正使用されるよう</b></nobr></div>
<div style="position:absolute;top:4664;left:452"><nobr><b>なことを防ぐための機構です．</b></nobr></div>
<div style="position:absolute;top:4687;left:464"><nobr><b>しかし，Ravaではそのようなチェックを行っており</b></nobr></div>
<div style="position:absolute;top:4709;left:452"><nobr><b>ません．扱うクラスファイルはすべて信頼できるもの</b></nobr></div>
<div style="position:absolute;top:4731;left:452"><nobr><b>として実行します．これはネットワーク越しでクラス</b></nobr></div>
<div style="position:absolute;top:4753;left:452"><nobr><b>ファイルをロードするようなことがないという前提で</b></nobr></div>
<div style="position:absolute;top:4775;left:452"><nobr><b>Ravaを開発していたからです<font style="font-size:5px">注3</font>．</b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:5091;left:608"><nobr><i><b>JAVA PRESS Vol.31</b></i><font style="font-size:10px">● </font><b><font style="font-size:14px">161</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:4702;left:140"><nobr>$ javap -c Counter</nobr></div>
<div style="position:absolute;top:4712;left:140"><nobr>Compiled from RavaTest.java</nobr></div>
<div style="position:absolute;top:4763;left:393"><nobr>О</nobr></div>
<div style="position:absolute;top:4806;left:217"><nobr>：</nobr></div>
<div style="position:absolute;top:4817;left:207"><nobr>（中略）</nobr></div>
<div style="position:absolute;top:4827;left:217"><nobr>：</nobr></div>
<div style="position:absolute;top:4931;left:393"><nobr>@</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:4685;left:139"><nobr>●図3 javapの実行結果</nobr></div>
</span></font>
<font size=2 color="#000000" face="Times"><span style="font-size:7px;font-family:Times;color:#000000">
<div style="position:absolute;top:4736;left:142"><nobr>class Counter extends java.lang.Object {</nobr></div>
<div style="position:absolute;top:4747;left:162"><nobr>public static void main(java.lang.String[]);</nobr></div>
<div style="position:absolute;top:4757;left:162"><nobr>Counter();</nobr></div>
<div style="position:absolute;top:4768;left:162"><nobr>public int add(int);</nobr></div>
<div style="position:absolute;top:4778;left:162"><nobr>public int get();</nobr></div>
<div style="position:absolute;top:4789;left:142"><nobr>}</nobr></div>
<div style="position:absolute;top:4844;left:142"><nobr>Method int add(int)</nobr></div>
<div style="position:absolute;top:4854;left:157"><nobr>0 iconst_0</nobr></div>
<div style="position:absolute;top:4865;left:157"><nobr>1 istore_2</nobr></div>
<div style="position:absolute;top:4875;left:157"><nobr>2 goto 18</nobr></div>
<div style="position:absolute;top:4886;left:157"><nobr>5 aload_0</nobr></div>
<div style="position:absolute;top:4896;left:157"><nobr>6 dup</nobr></div>
<div style="position:absolute;top:4907;left:157"><nobr>7 getfield #9 &lt;Field int counter&gt;</nobr></div>
<div style="position:absolute;top:4917;left:152"><nobr>10 iconst_1</nobr></div>
<div style="position:absolute;top:4928;left:152"><nobr>11 iadd </nobr></div>
<div style="position:absolute;top:4938;left:152"><nobr>12 putfield #9 &lt;Field int counter&gt;</nobr></div>
<div style="position:absolute;top:4949;left:152"><nobr>15 iinc 2 1</nobr></div>
<div style="position:absolute;top:4959;left:152"><nobr>18 iload_2</nobr></div>
<div style="position:absolute;top:4970;left:152"><nobr>19 iload_1</nobr></div>
<div style="position:absolute;top:4980;left:152"><nobr>20 if_icmplt 5</nobr></div>
<div style="position:absolute;top:4991;left:152"><nobr>23 aload_0</nobr></div>
<div style="position:absolute;top:5001;left:152"><nobr>24 getfield #9 &lt;Field int counter&gt;</nobr></div>
<div style="position:absolute;top:5012;left:152"><nobr>27 ireturn</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:4318;left:139"><nobr>★クラスファイルの構造</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:4838;left:455"><nobr>ClassFile {</nobr></div>
<div style="position:absolute;top:4849;left:465"><nobr>u4 magic;</nobr></div>
<div style="position:absolute;top:4859;left:465"><nobr>u2 minor_version;</nobr></div>
<div style="position:absolute;top:4870;left:465"><nobr>u2 major_version;</nobr></div>
<div style="position:absolute;top:4880;left:465"><nobr>u2 constant_pool_count;</nobr></div>
<div style="position:absolute;top:4891;left:465"><nobr>cp_info constant_pool[constant_pool_count-1];</nobr></div>
<div style="position:absolute;top:4901;left:465"><nobr>u2 access_flags;</nobr></div>
<div style="position:absolute;top:4912;left:465"><nobr>u2 this_class;</nobr></div>
<div style="position:absolute;top:4922;left:465"><nobr>u2 super_class;</nobr></div>
<div style="position:absolute;top:4933;left:465"><nobr>u2 interfaces_count;</nobr></div>
<div style="position:absolute;top:4943;left:465"><nobr>u2 interfaces[interfaces_count];</nobr></div>
<div style="position:absolute;top:4954;left:465"><nobr>u2 fields_count;</nobr></div>
<div style="position:absolute;top:4964;left:465"><nobr>field_info fields[fields_count];</nobr></div>
<div style="position:absolute;top:4975;left:465"><nobr>u2 methods_count;</nobr></div>
<div style="position:absolute;top:4985;left:465"><nobr>method_info methods[methods_count];</nobr></div>
<div style="position:absolute;top:4996;left:465"><nobr>u2 attributes_count;</nobr></div>
<div style="position:absolute;top:5006;left:465"><nobr>attribute_info attributes[attributes_count];</nobr></div>
<div style="position:absolute;top:5017;left:455"><nobr>}</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:4821;left:453"><nobr>●リスト2 クラスファイル構造体（C言語ライクな表現）</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:4495;left:454"><nobr>★クラスファイルのロード</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:5045;left:139"><nobr>注3：一番の理由は面倒くさかったから，ということなんですが．</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:4008;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ161</nobr></div>
</span></font>

<div style="position:absolute;top:5227;left:0"><hr><table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=5><b>Page 5</b></a></font></td></tr></table></div><font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:5439;left:149"><nobr><b>そのため，クラスロード時の一大イベントである検</b></nobr></div>
<div style="position:absolute;top:5461;left:137"><nobr><b>証のプロセスはすっ飛ばして，クラスをロードします．</b></nobr></div>
<div style="position:absolute;top:5483;left:149"><nobr><b>クラスファイルはバイナリファイルということは先</b></nobr></div>
<div style="position:absolute;top:5506;left:137"><nobr><b>ほど述べました．Rubyなどのスクリプト言語はバイ</b></nobr></div>
<div style="position:absolute;top:5528;left:137"><nobr><b>ナリファイルを扱うのが苦手である，というイメージ</b></nobr></div>
<div style="position:absolute;top:5550;left:137"><nobr><b>があるかもしれませんが，それがそうでもありません．</b></nobr></div>
<div style="position:absolute;top:5572;left:137"><nobr><b>Rubyの場合，</b>String::unpack<b>や</b>Array::pack</nobr></div>
<div style="position:absolute;top:5594;left:137"><nobr><b>メソッドを利用してバイナリデータを簡単に扱えます．</b></nobr></div>
<div style="position:absolute;top:5617;left:149"><nobr><b>また，クラスファイルをロードしたときに基底クラ</b></nobr></div>
<div style="position:absolute;top:5639;left:137"><nobr><b>スがロードされていなかった場合，基底クラスもロー</b></nobr></div>
<div style="position:absolute;top:5661;left:137"><nobr><b>ドします．これによって，クラスの派生関係をRava</b></nobr></div>
<div style="position:absolute;top:5683;left:137"><nobr><b>内部で正しく把握することができます．</b></nobr></div>
<div style="position:absolute;top:5772;left:149"><nobr><b>クラスファイルを読み込んだら，それを解釈して実</b></nobr></div>
<div style="position:absolute;top:5794;left:137"><nobr><b>行します．基本的には例外を無視すれば，次のような</b></nobr></div>
<div style="position:absolute;top:5816;left:137"><nobr><b>ループを実行します<font style="font-size:5px">注4</font>．</b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:5851;left:137"><nobr>do{</nobr></div>
<div style="position:absolute;top:5873;left:168"><nobr>PCが指す場所の命令を取得;</nobr></div>
<div style="position:absolute;top:5895;left:168"><nobr>取得した命令の操作を実行;</nobr></div>
<div style="position:absolute;top:5917;left:137"><nobr>}while(まだすることが残されているか?);</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:5950;left:150"><nobr><b>PCは実行すべき命令位置を示すもの（Program</b></nobr></div>
<div style="position:absolute;top:5972;left:137"><nobr><b>Counter）です．JVMの主な仕事はこれだけです．</b></nobr></div>
<div style="position:absolute;top:5994;left:137"><nobr><b>JVMって簡単でしょ？<font style="font-size:5px">注5</font></b></nobr></div>
<div style="position:absolute;top:6016;left:149"><nobr><b>本節では以降，JVMの実行に不可欠な要素を概観</b></nobr></div>
<div style="position:absolute;top:5439;left:450"><nobr><b>していきます．</b></nobr></div>
<div style="position:absolute;top:5506;left:462"><nobr><b>JVMはスタックマシンとして実現されています．ス</b></nobr></div>
<div style="position:absolute;top:5528;left:450"><nobr><b>タックマシンとは，演算する対象や演算した結果をス</b></nobr></div>
<div style="position:absolute;top:5550;left:450"><nobr><b>タックに保存するアーキテクチャです．たとえば足し</b></nobr></div>
<div style="position:absolute;top:5572;left:450"><nobr><b>算をする場合，スタックから2つの値を取り出し，そ</b></nobr></div>
<div style="position:absolute;top:5594;left:450"><nobr><b>れらを足し合わせた結果をスタックに積みます（図</b></nobr></div>
<div style="position:absolute;top:5616;left:450"><nobr><b>4）．</b></nobr></div>
<div style="position:absolute;top:5639;left:462"><nobr><b>JVMではこのような計算をオペランドスタックとい</b></nobr></div>
<div style="position:absolute;top:5661;left:450"><nobr><b>うスタックを用いて実行します．</b></nobr></div>
<div style="position:absolute;top:5683;left:462"><nobr><b>RavaではオペランドスタックをRubyの配列で実現</b></nobr></div>
<div style="position:absolute;top:5705;left:450"><nobr><b>しました．Rubyの配列にはスタック操作をするため</b></nobr></div>
<div style="position:absolute;top:5728;left:450"><nobr><b>の十分な機能がサポートされているためです<font style="font-size:5px">注6</font>．</b></nobr></div>
<div style="position:absolute;top:5794;left:462"><nobr><b>Javaの型はおおまかに言って，プリミティブ型とリ</b></nobr></div>
<div style="position:absolute;top:5816;left:450"><nobr><b>ファレンス型に分かれます．要するに数値などのデー</b></nobr></div>
<div style="position:absolute;top:5839;left:450"><nobr><b>タか，オブジェクトか，ということです．</b></nobr></div>
<div style="position:absolute;top:5861;left:463"><nobr><b>JVM上では型に応じた命令セットを持ちます．た</b></nobr></div>
<div style="position:absolute;top:5883;left:450"><nobr><b>だし，</b>byte<b>，</b>short<b>，</b>char<b>型については，だいた</b></nobr></div>
<div style="position:absolute;top:5905;left:450"><nobr><b>い</b>int<b>型と同じ命令によって計算されます．</b></nobr></div>
<div style="position:absolute;top:5927;left:462"><nobr><b>Ravaではプリミティブ型はそのままRubyの数値型</b></nobr></div>
<div style="position:absolute;top:5950;left:450"><nobr><b>で表します．リファレンス型，たとえばJavaのオブジ</b></nobr></div>
<div style="position:absolute;top:5972;left:450"><nobr><b>ェクトは，フィールド領域とそのクラスへのリファレ</b></nobr></div>
<div style="position:absolute;top:5994;left:450"><nobr><b>ンスを持つRubyオブジェクトとして表現しました．フ</b></nobr></div>
<div style="position:absolute;top:6016;left:450"><nobr><b>ィールド領域はフィールド名をキーとするハッシュに</b></nobr></div>
<div style="position:absolute;top:6038;left:450"><nobr><b>よって表現しました．</b></nobr></div>
<div style="position:absolute;top:6105;left:462"><nobr><b>JVMでは，200もの命令が規定されています．これ</b></nobr></div>
<div style="position:absolute;top:6127;left:450"><nobr><b>らを詳細に述べていくと，誌面がすぐに尽きてしまう</b></nobr></div>
<div style="position:absolute;top:6149;left:450"><nobr><b>ので，どのような命令セットであるか，JVM仕様にあ</b></nobr></div>
<div style="position:absolute;top:6172;left:450"><nobr><b>る命令セットのカテゴリを紹介します．</b></nobr></div>
<div style="position:absolute;top:6215;left:450"><nobr>!ロード命令とストア命令</nobr></div>
<div style="position:absolute;top:6237;left:450"><nobr>!算術命令</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:6350;left:91"><nobr><b>162 </b><font style="font-size:10px">●</font><i><b><font style="font-size:8px">JAVA PRESS Vol.31</font></b></i></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:5724;left:140"><nobr>解釈実行</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:6267;left:137"><nobr>注4：JVM仕様の記述と若干変更してあります．</nobr></div>
<div style="position:absolute;top:6282;left:137"><nobr>注5：これ以外の主でない部分が面倒なんですけどね．</nobr></div>
<div style="position:absolute;top:6297;left:137"><nobr>注6：たとえばJavaの配列は固定長ですが，Rubyの配列は可変長です．要するにRubyの配列がjava.util.ArrayListのようなものと</nobr></div>
<div style="position:absolute;top:6312;left:164"><nobr>いうことです（もっと高機能ですが）．効率は犠牲になりますが，プログラミングは楽になります．</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:5470;left:453"><nobr>★スタックマシン</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:6132;left:177"><nobr>a</nobr></div>
<div style="position:absolute;top:6115;left:177"><nobr>b</nobr></div>
<div style="position:absolute;top:6116;left:257"><nobr>a</nobr></div>
<div style="position:absolute;top:6096;left:274"><nobr>b</nobr></div>
<div style="position:absolute;top:6134;left:329"><nobr>a+b</nobr></div>
<div style="position:absolute;top:6110;left:277"><nobr>+</nobr></div>
<div style="position:absolute;top:6184;left:168"><nobr>（1）??     （2）    </nobr></div>
<div style="position:absolute;top:6184;left:324"><nobr>（3）</nobr></div>
<div style="position:absolute;top:6210;left:153"><nobr>（1）値a，bをスタックに積む</nobr></div>
<div style="position:absolute;top:6222;left:153"><nobr>（2）値a，bをスタックから取り出し，a+bを計算する</nobr></div>
<div style="position:absolute;top:6234;left:153"><nobr>（3）値a+bをスタックに積む</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:6058;left:137"><nobr>●図4 スタックマシンで足し算（a+b）を行う様子</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:5758;left:453"><nobr>★型とデータ表現</nobr></div>
<div style="position:absolute;top:6069;left:453"><nobr>★JVMの命令セット</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:5271;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ162</nobr></div>
</span></font>

<div style="position:absolute;top:6490;left:0"><hr><table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=6><b>Page 6</b></a></font></td></tr></table></div><font size=3 color="#231f20" face="Times"><span style="font-size:10px;font-family:Times;color:#231f20">
<div style="position:absolute;top:6701;left:139"><nobr>!型変換命令</nobr></div>
<div style="position:absolute;top:6723;left:139"><nobr>!オブジェクト生成と操作</nobr></div>
<div style="position:absolute;top:6745;left:139"><nobr>!オペランドスタック管理命令</nobr></div>
<div style="position:absolute;top:6768;left:139"><nobr>!制御の移行命令</nobr></div>
<div style="position:absolute;top:6790;left:139"><nobr>!メソッド起動とリターン命令</nobr></div>
<div style="position:absolute;top:6812;left:139"><nobr>!例外のスロー</nobr></div>
<div style="position:absolute;top:6834;left:139"><nobr>!finallyの実装</nobr></div>
<div style="position:absolute;top:6856;left:139"><nobr>!同期化</nobr></div>
<div style="position:absolute;top:6902;left:151"><nobr><b>各命令は1バイトのオペコードに続いて，引数，あ</b></nobr></div>
<div style="position:absolute;top:6924;left:139"><nobr><b>るいは命令が用いるデータとなるオペランドを0個以</b></nobr></div>
<div style="position:absolute;top:6946;left:139"><nobr><b>上続けたものから構成されます．中には可変長のオペ</b></nobr></div>
<div style="position:absolute;top:6968;left:139"><nobr><b>ランドを持つ命令もあり，なかなか凶悪です．</b></nobr></div>
<div style="position:absolute;top:6991;left:151"><nobr><b>余談ですが，仮想じゃない機械の命令セットは，命</b></nobr></div>
<div style="position:absolute;top:7013;left:139"><nobr><b>令のビットパターンで，この命令はどういう処理をす</b></nobr></div>
<div style="position:absolute;top:7035;left:139"><nobr><b>る，ということがわかるそうですね．命令デコードが</b></nobr></div>
<div style="position:absolute;top:7057;left:139"><nobr><b>簡単になるからだと思います．が，JVMの命令セット</b></nobr></div>
<div style="position:absolute;top:7079;left:139"><nobr><b>はただ機能ごとに番号を振っていっただけなのでその</b></nobr></div>
<div style="position:absolute;top:7102;left:139"><nobr><b>ようになっていません．以前JVMをチップ上に載せよ</b></nobr></div>
<div style="position:absolute;top:7124;left:139"><nobr><b>うとしていた人が嘆いていました．</b></nobr></div>
<div style="position:absolute;top:7190;left:151"><nobr><b>メソッドを起動すると，各スレッドが1つずつ持つ</b></nobr></div>
<div style="position:absolute;top:7213;left:139"><nobr><b>JVMスタック上に“フレーム”を作ります．フレーム</b></nobr></div>
<div style="position:absolute;top:7235;left:139"><nobr><b>を利用してJVMはメソッドを実行します．</b></nobr></div>
<div style="position:absolute;top:7257;left:151"><nobr><b>フレームにはそのメソッドで利用する“ローカル変</b></nobr></div>
<div style="position:absolute;top:7279;left:139"><nobr><b>数領域”とメソッド実行用の“オペランドスタック”，</b></nobr></div>
<div style="position:absolute;top:7301;left:139"><nobr><b>そしてそのメソッドのクラスに対する実行時コンスタ</b></nobr></div>
<div style="position:absolute;top:7324;left:139"><nobr><b>ントプールへの参照が含まれます．</b></nobr></div>
<div style="position:absolute;top:7346;left:151"><nobr><b>メソッドが終了（リターン命令による終了や例外発</b></nobr></div>
<div style="position:absolute;top:7368;left:139"><nobr><b>生による途中終了）したら，JVMスタックからそのメ</b></nobr></div>
<div style="position:absolute;top:7390;left:139"><nobr><b>ソッドが構築したフレームが取り除かれ，呼び出し元</b></nobr></div>
<div style="position:absolute;top:7412;left:139"><nobr><b>メソッドの実行が再開されます．値を返す場合，呼び</b></nobr></div>
<div style="position:absolute;top:7435;left:139"><nobr><b>出し元メソッドのオペランドスタックへ値を積みます．</b></nobr></div>
<div style="position:absolute;top:7457;left:151"><nobr><b>Ravaでは具体的に図5のようなフレームを作ること</b></nobr></div>
<div style="position:absolute;top:7479;left:139"><nobr><b>にしました．まずローカル変数領域があり，その上に</b></nobr></div>
<div style="position:absolute;top:7501;left:139"><nobr><b>呼び出し元メソッドのフレームを復帰するためのフレ</b></nobr></div>
<div style="position:absolute;top:7523;left:139"><nobr><b>ーム情報を積み，その上をオペランドスタックとして</b></nobr></div>
<div style="position:absolute;top:7546;left:139"><nobr><b>利用するようにしました．JVMスタックが1つの配列</b></nobr></div>
<div style="position:absolute;top:7568;left:139"><nobr><b>で表現されており，フレーム，そしてオペランドスタ</b></nobr></div>
<div style="position:absolute;top:6702;left:452"><nobr><b>ックをその配列の一部として実現しました．</b></nobr></div>
<div style="position:absolute;top:6724;left:464"><nobr><b>メソッドが終了すると，フレーム情報を利用して呼</b></nobr></div>
<div style="position:absolute;top:6746;left:452"><nobr><b>び出し元メソッドのフレームを復元します．</b></nobr></div>
<div style="position:absolute;top:6813;left:464"><nobr><b>JVM命令セットには，入出力（環境依存の操作）</b></nobr></div>
<div style="position:absolute;top:6835;left:452"><nobr><b>やスレッドの制御（VMの操作）などを行うための命</b></nobr></div>
<div style="position:absolute;top:6857;left:452"><nobr><b>令はありません．これらを実現するためにJava仕様，</b></nobr></div>
<div style="position:absolute;top:6880;left:452"><nobr><b>およびJVMにはネイティブメソッドがあります．</b></nobr></div>
<div style="position:absolute;top:6902;left:464"><nobr><b>ネイティブメソッドとはJava以外の言語によって記</b></nobr></div>
<div style="position:absolute;top:6924;left:452"><nobr><b>述されたメソッドを実行するためのもので，たとえば</b></nobr></div>
<div style="position:absolute;top:6946;left:452"><nobr><b>C言語で記述したメソッドによって入出力を実現した</b></nobr></div>
<div style="position:absolute;top:6968;left:452"><nobr><b>り，JVMのスレッド生成を行います．Javaプログラム</b></nobr></div>
<div style="position:absolute;top:6991;left:452"><nobr><b>中，メソッド名の前に</b>native<b>として記述すれば，コ</b></nobr></div>
<div style="position:absolute;top:7013;left:452"><nobr><b>ンパイラはそれをネイティブメソッドとして認識し，</b></nobr></div>
<div style="position:absolute;top:7035;left:452"><nobr><b>クラスファイルにもそのように記述されます．ネイテ</b></nobr></div>
<div style="position:absolute;top:7057;left:452"><nobr><b>ィブメソッドをどのようにJVMとバインドするか，な</b></nobr></div>
<div style="position:absolute;top:7079;left:452"><nobr><b>どはOSのローダなどとの兼ね合いから実装依存とな</b></nobr></div>
<div style="position:absolute;top:7102;left:452"><nobr><b>っています．また，ネイティブメソッドをC言語など</b></nobr></div>
<div style="position:absolute;top:7124;left:452"><nobr><b>でどのように記述すればよいかを定めたAPIであるJNI</b></nobr></div>
<div style="position:absolute;top:7146;left:446"><nobr><b>（Java Native Interface）<font style="font-size:5px">［9］</font>という仕様もあります．</b></nobr></div>
<div style="position:absolute;top:7168;left:464"><nobr><b>JVM仕様では，どのようにネイティブメソッドを記</b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:7617;left:608"><nobr><i><b>JAVA PRESS Vol.31</b></i><font style="font-size:10px">● </font><b><font style="font-size:14px">163</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:7249;left:632"><nobr>オペランドスタック</nobr></div>
<div style="position:absolute;top:7261;left:632"><nobr>（計算に利用）</nobr></div>
<div style="position:absolute;top:7318;left:632"><nobr>呼び出し元フレーム情報</nobr></div>
<div style="position:absolute;top:7329;left:632"><nobr>（フレームを戻すときに利用）</nobr></div>
<div style="position:absolute;top:7380;left:632"><nobr>ローカル変数領域</nobr></div>
<div style="position:absolute;top:7391;left:632"><nobr>（引数を含むメソッドのローカル</nobr></div>
<div style="position:absolute;top:7403;left:632"><nobr>変数を格納）</nobr></div>
<div style="position:absolute;top:7292;left:631"><nobr>SP：Stack Pointer</nobr></div>
<div style="position:absolute;top:7420;left:631"><nobr>FP：Frame Pointer</nobr></div>
<div style="position:absolute;top:7452;left:631"><nobr>呼び出し元メソッドフレーム</nobr></div>
<div style="position:absolute;top:7491;left:509"><nobr>JVMスタック</nobr></div>
<div style="position:absolute;top:7283;left:451"><nobr>メ</nobr></div>
<div style="position:absolute;top:7294;left:451"><nobr>ソ</nobr></div>
<div style="position:absolute;top:7306;left:451"><nobr>ッ</nobr></div>
<div style="position:absolute;top:7317;left:451"><nobr>ド</nobr></div>
<div style="position:absolute;top:7328;left:451"><nobr>フ</nobr></div>
<div style="position:absolute;top:7340;left:451"><nobr>レ</nobr></div>
<div style="position:absolute;top:7363;left:451"><nobr>ム</nobr></div>
<div style="position:absolute;top:7352;left:451"><nobr>ー</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:7202;left:452"><nobr>●図5 Ravaのメソッドフレーム</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:7155;left:139"><nobr>★メソッド起動</nobr></div>
<div style="position:absolute;top:6777;left:454"><nobr>★ネイティブメソッド</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:7524;left:456"><nobr>"Q <b><font style="font-size:10px">参考文献</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:7548;left:451"><nobr>［9］Java Native Interface：http://java.sun.com/j2se/1.4/ja/</nobr></div>
<div style="position:absolute;top:7563;left:475"><nobr>docs/ja/guide/jni/</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:6534;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ163</nobr></div>
</span></font>

<div style="position:absolute;top:7753;left:0"><hr><table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=7><b>Page 7</b></a></font></td></tr></table></div><font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:7965;left:137"><nobr><b>述し実行させるかということを規定していないため，</b></nobr></div>
<div style="position:absolute;top:7987;left:137"><nobr><b>RavaではネイティブメソッドをRubyで記述できるよ</b></nobr></div>
<div style="position:absolute;top:8009;left:137"><nobr><b>うにしました．つまり，Javaプログラム中でネイティ</b></nobr></div>
<div style="position:absolute;top:8032;left:137"><nobr><b>ブメソッドが起動されたとき，対応するRubyメソッ</b></nobr></div>
<div style="position:absolute;top:8054;left:137"><nobr><b>ドを起動するのです．</b></nobr></div>
<div style="position:absolute;top:8076;left:149"><nobr><b>このおかげで従来はC言語などで記述しなければい</b></nobr></div>
<div style="position:absolute;top:8098;left:137"><nobr><b>けなかったネイティブメソッドがRubyで簡単に記述</b></nobr></div>
<div style="position:absolute;top:8120;left:137"><nobr><b>できるようになりました．しかし逆に，ネイティブメ</b></nobr></div>
<div style="position:absolute;top:8143;left:137"><nobr><b>ソッドに関する過去の資産が使えません．そのため，</b></nobr></div>
<div style="position:absolute;top:8165;left:137"><nobr><b>たとえばウィンドウシステムを利用するようなJava API</b></nobr></div>
<div style="position:absolute;top:8187;left:137"><nobr><b>はRavaではサポートしてません．</b></nobr></div>
<div style="position:absolute;top:8209;left:149"><nobr><b>ちなみにリスト1の</b>rj.out<b>メソッドはネイティブ</b></nobr></div>
<div style="position:absolute;top:8231;left:137"><nobr><b>メソッドを利用する出力メソッドです．</b></nobr></div>
<div style="position:absolute;top:8298;left:149"><nobr><b>Javaには例外処理機構があります．</b>try/catch<b>で</b></nobr></div>
<div style="position:absolute;top:8320;left:137"><nobr><b>挟むあれです．</b>try<b>節で発生した例外は，その例外が</b></nobr></div>
<div style="position:absolute;top:8343;left:137"><nobr>catch<b>節でフックされていれば，その</b>catch<b>節が実</b></nobr></div>
<div style="position:absolute;top:8365;left:137"><nobr><b>行されます．また，</b>finally<b>節がある場合，例外が</b></nobr></div>
<div style="position:absolute;top:8387;left:137"><nobr><b>起こったか起こらなかったかに関わらず</b>finally<b>節</b></nobr></div>
<div style="position:absolute;top:8409;left:137"><nobr><b>が実行されます．</b>catch<b>されない例外は，呼び出し</b></nobr></div>
<div style="position:absolute;top:8431;left:137"><nobr><b>元メソッドへ例外を伝播します．</b></nobr></div>
<div style="position:absolute;top:8453;left:149"><nobr><b>さて，JVMではこれを“例外テーブル”（表1）と</b></nobr></div>
<div style="position:absolute;top:8476;left:137"><nobr><b>いうものを利用して実現します．例外テーブルは各メ</b></nobr></div>
<div style="position:absolute;top:8498;left:137"><nobr><b>ソッドそれぞれが保持しています．例外テーブルによ</b></nobr></div>
<div style="position:absolute;top:8520;left:137"><nobr><b>って，“どこで例外が起こったか”，“どの例外が発生</b></nobr></div>
<div style="position:absolute;top:8542;left:137"><nobr><b>したか”という情報をキーとして，“どのような処理</b></nobr></div>
<div style="position:absolute;top:8564;left:137"><nobr><b>を行う”という情報を引き出し，例外処理機構を実</b></nobr></div>
<div style="position:absolute;top:8587;left:137"><nobr><b>現します．</b></nobr></div>
<div style="position:absolute;top:7965;left:462"><nobr><b>Ravaではこの動作をRubyの例外を利用して実現し</b></nobr></div>
<div style="position:absolute;top:7987;left:450"><nobr><b>ました．つまり，解釈実行のループ中でJavaの例外が</b></nobr></div>
<div style="position:absolute;top:8009;left:450"><nobr><b>発生した場合，Rubyの例外を発生させてしまいます．</b></nobr></div>
<div style="position:absolute;top:8032;left:450"><nobr><b>ループから出た時点ですべてのRubyの例外を補足し，</b></nobr></div>
<div style="position:absolute;top:8054;left:450"><nobr><b>現在実行中のJavaメソッドの例外テーブルを検索しま</b></nobr></div>
<div style="position:absolute;top:8076;left:450"><nobr><b>す．もし該当エントリがあればその情報を元にJVMの</b></nobr></div>
<div style="position:absolute;top:8098;left:450"><nobr><b>実行を再開します．なければメソッドフレームをさか</b></nobr></div>
<div style="position:absolute;top:8120;left:450"><nobr><b>のぼって検索を続けます．</b></nobr></div>
<div style="position:absolute;top:8187;left:463"><nobr><b>ガーベッジコレクション（GC）は不要なメモリを</b></nobr></div>
<div style="position:absolute;top:8209;left:450"><nobr><b>システムが勝手に回収し，再利用可能にする機能で</b></nobr></div>
<div style="position:absolute;top:8231;left:450"><nobr><b>す．スレッドは実行する命令流を仮想化し，ソフトウ</b></nobr></div>
<div style="position:absolute;top:8254;left:450"><nobr><b>ェアで複数制御できるようにしたものです．</b></nobr></div>
<div style="position:absolute;top:8276;left:463"><nobr><b>なぜこの2つを並べて書いているかというと，Rava</b></nobr></div>
<div style="position:absolute;top:8298;left:450"><nobr><b>ではこれらの実装をRubyのGCおよびスレッド機能で</b></nobr></div>
<div style="position:absolute;top:8320;left:450"><nobr><b>そのまま実現しているためです．たとえば，Javaのオ</b></nobr></div>
<div style="position:absolute;top:8342;left:450"><nobr><b>ブジェクトを</b>new<b>すると，RavaはRubyのオブジェク</b></nobr></div>
<div style="position:absolute;top:8365;left:450"><nobr><b>トを生成します．そのJavaオブジェクトが必要なくな</b></nobr></div>
<div style="position:absolute;top:8387;left:450"><nobr><b>ったとき，RubyのGC機能がいいようにしてくれま</b></nobr></div>
<div style="position:absolute;top:8409;left:450"><nobr><b>す．楽です．</b></nobr></div>
<div style="position:absolute;top:8431;left:463"><nobr><b>スレッドは，Javaのスレッドが生成されたとき，</b></nobr></div>
<div style="position:absolute;top:8453;left:450"><nobr><b>Rubyのスレッドを生成して，その上でバイトコード</b></nobr></div>
<div style="position:absolute;top:8476;left:450"><nobr><b>の解釈実行を行います．楽です．</b></nobr></div>
<div style="position:absolute;top:8498;left:463"><nobr><b>ただし，これらの機能はまだ厳密にJVM仕様を満</b></nobr></div>
<div style="position:absolute;top:8520;left:450"><nobr><b>足しておらず，たとえばJava のファイナライズやスレ</b></nobr></div>
<div style="position:absolute;top:8542;left:450"><nobr><b>ッドの同期などはRavaでは未着手です<font style="font-size:5px">注7</font>．特にスレ</b></nobr></div>
<div style="position:absolute;top:8564;left:450"><nobr><b>ッドの同期に対応していないのはスレッドプログラミ</b></nobr></div>
<div style="position:absolute;top:8587;left:450"><nobr><b>ングにとっては致命的なので，Ravaではスレッドはな</b></nobr></div>
<div style="position:absolute;top:8609;left:450"><nobr><b>んちゃってサポートです．</b></nobr></div>
<div style="position:absolute;top:8631;left:462"><nobr><b>では，RubyでGCやスレッドをどのように実現して</b></nobr></div>
<div style="position:absolute;top:8653;left:450"><nobr><b>いるか，そもそもRubyインタープリタはどのように</b></nobr></div>
<div style="position:absolute;top:8675;left:450"><nobr><b>動いているのか，という詳細は文献<font style="font-size:5px">［10］</font>を参照してく</b></nobr></div>
<div style="position:absolute;top:8698;left:450"><nobr><b>ださい．</b></nobr></div>
<div style="position:absolute;top:8786;left:463"><nobr><b>前節までで説明した範囲を実装することで，Rava</b></nobr></div>
<div style="position:absolute;top:8809;left:450"><nobr><b>をとりあえず動かすことができました．しかし，実行</b></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:8876;left:91"><nobr><b>164 </b><font style="font-size:10px">●</font><i><b><font style="font-size:8px">JAVA PRESS Vol.31</font></b></i></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:8262;left:138"><nobr>★例外処理</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:8630;left:137"><nobr>●表1 例外テーブルの例</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:8151;left:453"><nobr>★GCやスレッド</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:8669;left:170"><nobr>10</nobr></div>
<div style="position:absolute;top:8669;left:238"><nobr>20</nobr></div>
<div style="position:absolute;top:8669;left:306"><nobr>A</nobr></div>
<div style="position:absolute;top:8669;left:374"><nobr>100</nobr></div>
<div style="position:absolute;top:8684;left:170"><nobr>10</nobr></div>
<div style="position:absolute;top:8684;left:238"><nobr>20</nobr></div>
<div style="position:absolute;top:8684;left:306"><nobr>B</nobr></div>
<div style="position:absolute;top:8684;left:374"><nobr>200</nobr></div>
<div style="position:absolute;top:8699;left:170"><nobr>…</nobr></div>
<div style="position:absolute;top:8699;left:238"><nobr>…</nobr></div>
<div style="position:absolute;top:8699;left:306"><nobr>…</nobr></div>
<div style="position:absolute;top:8699;left:377"><nobr>…</nobr></div>
</span></font>
<font size=2 color="#000000" face="Times"><span style="font-size:7px;font-family:Times;color:#000000">
<div style="position:absolute;top:8649;left:160"><nobr>start_pc    </nobr></div>
<div style="position:absolute;top:8649;left:227"><nobr>end_pc    </nobr></div>
<div style="position:absolute;top:8649;left:286"><nobr>catch_type    </nobr></div>
<div style="position:absolute;top:8649;left:363"><nobr>handler_pc</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:8719;left:137"><nobr>※オフセット10?20を実行中に例外Aが発生したら処理を100</nobr></div>
<div style="position:absolute;top:8731;left:149"><nobr>に，Bなら200に移す</nobr></div>
<div style="position:absolute;top:8837;left:137"><nobr>注7：ごめんなさい．面倒くさかったんです．</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:14px;font-family:Times">
<div style="position:absolute;top:8763;left:140"><nobr>"Q <b><font style="font-size:10px">参考文献</font></b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:8787;left:135"><nobr>［10］『Rubyソースコード完全解説』／青木峰郎著／まつもとゆ</nobr></div>
<div style="position:absolute;top:8802;left:162"><nobr>きひろ監修／インプレス 2002</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:8739;left:455"><nobr>もっと速く！</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:7797;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ164</nobr></div>
</span></font>

<div style="position:absolute;top:9016;left:0"><hr><table border=0 width=100%><tr><td bgcolor=eeeeee align=right><font face=arial,sans-serif><a name=8><b>Page 8</b></a></font></td></tr></table></div><font size=3 color="#231f20" face="Times"><span style="font-size:10px;font-family:Times;color:#231f20">
<div style="position:absolute;top:9228;left:139"><nobr><b>速度が涙が出るほど遅いものになってしまいました．</b></nobr></div>
<div style="position:absolute;top:9250;left:151"><nobr><b>これは，Ravaがスタックマシンの挙動を非常に素</b></nobr></div>
<div style="position:absolute;top:9272;left:139"><nobr><b>直に，悪く言えば馬鹿正直に実行しているためです．</b></nobr></div>
<div style="position:absolute;top:9295;left:139"><nobr><b>なんとかならないものでしょうか．</b></nobr></div>
<div style="position:absolute;top:9317;left:151"><nobr><b>世の中ではさまざまなJVMの高速化手法が考案さ</b></nobr></div>
<div style="position:absolute;top:9339;left:139"><nobr><b>れています．そこで，それらを少し紹介してみます．</b></nobr></div>
<div style="position:absolute;top:9361;left:151"><nobr><b>JIT（Just-In-Time）コンパイラによる高速化は，実</b></nobr></div>
<div style="position:absolute;top:9383;left:139"><nobr><b>行時にバイトコードをコンパイルする手法です．一般</b></nobr></div>
<div style="position:absolute;top:9406;left:139"><nobr><b>的に，バイトコードを実行環境の機械語列へ変換する</b></nobr></div>
<div style="position:absolute;top:9428;left:139"><nobr><b>ことでより高速な実行を可能にします．ただし，メモ</b></nobr></div>
<div style="position:absolute;top:9450;left:139"><nobr><b>リ使用量が非常に増えます．ほとんどのJVMはこの</b></nobr></div>
<div style="position:absolute;top:9472;left:139"><nobr><b>機構により高速化を行っているようですが，組み込み</b></nobr></div>
<div style="position:absolute;top:9494;left:139"><nobr><b>JVMなどでは利用可能リソースの関係からこれの適用</b></nobr></div>
<div style="position:absolute;top:9517;left:139"><nobr><b>が難しい場合があるようです．</b></nobr></div>
<div style="position:absolute;top:9539;left:151"><nobr><b>AOT（Ahead-On-Time）コンパイラは，実行時に</b></nobr></div>
<div style="position:absolute;top:9561;left:139"><nobr><b>コンパイルを行うJITコンパイラと違い，実行前にさ</b></nobr></div>
<div style="position:absolute;top:9583;left:139"><nobr><b>っさとコンパイルをやっておこうというものです．実</b></nobr></div>
<div style="position:absolute;top:9605;left:139"><nobr><b>行前にコンパイルを終わらせてしまうため，コンパイ</b></nobr></div>
<div style="position:absolute;top:9628;left:139"><nobr><b>ル時間を縮小できるという利点があります．</b></nobr></div>
<div style="position:absolute;top:9228;left:464"><nobr><b>SunのHotSpotVMなどでは，実行時プロファイリ</b></nobr></div>
<div style="position:absolute;top:9250;left:452"><nobr><b>ングによって何度も実行する部分（HotSpot）のみを</b></nobr></div>
<div style="position:absolute;top:9272;left:452"><nobr><b>コンパイルしようというアプローチをとっています．た</b></nobr></div>
<div style="position:absolute;top:9295;left:452"><nobr><b>とえば初期化のために一度しか呼ばれないメソッドを</b></nobr></div>
<div style="position:absolute;top:9317;left:452"><nobr><b>コンパイルするよりは，何度も実行されるメソッドを</b></nobr></div>
<div style="position:absolute;top:9339;left:452"><nobr><b>コンパイルしたほうが処理速度は向上します．</b></nobr></div>
<div style="position:absolute;top:9406;left:464"><nobr><b>どうやら，バイトコードをなにかに変換すると実行</b></nobr></div>
<div style="position:absolute;top:9428;left:452"><nobr><b>速度を速くすることができそうです．そこで，実行時</b></nobr></div>
<div style="position:absolute;top:9450;left:452"><nobr><b>にバイトコードをそれと同等の働きをするRubyスクリ</b></nobr></div>
<div style="position:absolute;top:9472;left:452"><nobr><b>プトに変換し，それを実行するような機構（JITコン</b></nobr></div>
<div style="position:absolute;top:9494;left:452"><nobr><b>パイラ）を試作してみました．どのバイトコードをコ</b></nobr></div>
<div style="position:absolute;top:9517;left:452"><nobr><b>ンパイルするかはメソッド起動回数を集計するような</b></nobr></div>
<div style="position:absolute;top:9539;left:452"><nobr><b>簡単なプロファイラを用意し，起動回数によってコン</b></nobr></div>
<div style="position:absolute;top:9561;left:452"><nobr><b>パイルするメソッドを決定するようにしました．</b></nobr></div>
<div style="position:absolute;top:9583;left:464"><nobr><b>Rubyでは</b>eval<b>メソッドによって実行時にRubyス</b></nobr></div>
<div style="position:absolute;top:9605;left:452"><nobr><b>クリプトを評価（Evaluate）することができるため，</b></nobr></div>
<div style="position:absolute;top:9628;left:452"><nobr><b>そのような処理がやりやすかったのです．</b></nobr></div>
<div style="position:absolute;top:9650;left:464"><nobr><b>この試作では，実行速度がインタプリタのままの性</b></nobr></div>
<div style="position:absolute;top:9672;left:452"><nobr><b>能よりも25倍も向上することができました<font style="font-size:5px">注8</font>（詳細</b></nobr></div>
<div style="position:absolute;top:9694;left:452"><nobr><b>はサポートページ<font style="font-size:5px">［1］</font>をご覧ください）．</b></nobr></div>
<div style="position:absolute;top:9783;left:464"><nobr><b>いかがでしたでしょうか．JVMはこんなことをやっ</b></nobr></div>
<div style="position:absolute;top:9805;left:452"><nobr><b>ているのか，と雰囲気だけでも掴んでいただければ幸</b></nobr></div>
<div style="position:absolute;top:9827;left:452"><nobr><b>いです．ついでに，Rubyに興味を持った，使ってみ</b></nobr></div>
<div style="position:absolute;top:9850;left:452"><nobr><b>たい，と思ってもらえるとこちらの思うツボです．</b></nobr></div>
<div style="position:absolute;top:9872;left:464"><nobr><b>言語処理系をいじるのは楽しいです．ちゃんと動い</b></nobr></div>
<div style="position:absolute;top:9894;left:452"><nobr><b>てくれると本当に嬉しいです．処理系上で動作するプ</b></nobr></div>
<div style="position:absolute;top:9916;left:452"><nobr><b>ログラミング言語への理解も深まります．Rubyだと</b></nobr></div>
<div style="position:absolute;top:9938;left:452"><nobr><b>いろいろ簡単に作れますし．まだまだやめられそうに</b></nobr></div>
<div style="position:absolute;top:9961;left:452"><nobr><b>ありません．</b></nobr></div>
<div style="position:absolute;top:9983;left:464"><nobr><b>最後に，本稿執筆にあたり，お世話になった方々，</b></nobr></div>
<div style="position:absolute;top:10005;left:452"><nobr><b>相談にのっていただいた方々，そして最後まで読んく</b></nobr></div>
<div style="position:absolute;top:10027;left:452"><nobr><b>れたあなたに，感謝いたします．</b><font style="font-size:13px">J</font></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:8px;font-family:Times">
<div style="position:absolute;top:10143;left:608"><nobr><i><b>JAVA PRESS Vol.31</b></i><font style="font-size:10px">● </font><b><font style="font-size:14px">165</font></b></nobr></div>
</span></font>
<font size=2 color="#000000" face="Times"><span style="font-size:9px;font-family:Times;color:#000000">
<div style="position:absolute;top:9667;left:148"><nobr><b>Column</b></nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:12px;font-family:Times">
<div style="position:absolute;top:9682;left:148"><nobr><b>★静的な言語，動的な言語</b></nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:9px;font-family:Times">
<div style="position:absolute;top:9712;left:162"><nobr>Rubyでは，evalメソッドがあったり，クラスを実</nobr></div>
<div style="position:absolute;top:9732;left:151"><nobr>行時にいじったり，メソッドを上書きできたりと，動</nobr></div>
<div style="position:absolute;top:9751;left:151"><nobr>的で柔軟な言語です．Java はそのような点で静的な</nobr></div>
<div style="position:absolute;top:9771;left:151"><nobr>言語と言えると思います．</nobr></div>
<div style="position:absolute;top:9790;left:162"><nobr>動的な言語では，プログラミングの幅が広がります．</nobr></div>
<div style="position:absolute;top:9810;left:151"><nobr>たとえば，本稿で述べた高速化の試みでは，動的にメ</nobr></div>
<div style="position:absolute;top:9829;left:151"><nobr>ソッドをクラスへ追加するという実装を行いました．</nobr></div>
<div style="position:absolute;top:9849;left:162"><nobr>しかし，すべてが実行時まで決まらないため，Ruby</nobr></div>
<div style="position:absolute;top:9868;left:151"><nobr>は非常に最適化がしにくい言語になっています．たと</nobr></div>
<div style="position:absolute;top:9888;left:151"><nobr>えば，1+1というRuby プログラムを，パースした時</nobr></div>
<div style="position:absolute;top:9907;left:151"><nobr>点で2とすることが出来ません．これは，足し算を行</nobr></div>
<div style="position:absolute;top:9927;left:151"><nobr>うときに呼ばれるFixnum::+というメソッドの挙動</nobr></div>
<div style="position:absolute;top:9946;left:151"><nobr>が実行時に変更される可能性があるためです．</nobr></div>
<div style="position:absolute;top:9966;left:162"><nobr>Java は，Ruby に比べるとコンパイル時にほとん</nobr></div>
<div style="position:absolute;top:9985;left:151"><nobr>どのことが確定するため，最適化に適したつくりと言</nobr></div>
<div style="position:absolute;top:10005;left:151"><nobr>えます．プログラミングのしやすさを取るか，実行効率</nobr></div>
<div style="position:absolute;top:10024;left:151"><nobr>をとるか，そのバランスの違いがRuby とJava との</nobr></div>
<div style="position:absolute;top:10044;left:151"><nobr>違いの1つなのかな，と思います．</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:11px;font-family:Times">
<div style="position:absolute;top:9370;left:454"><nobr>★Ravaの場合</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:16px;font-family:Times">
<div style="position:absolute;top:9735;left:456"><nobr>おわりに</nobr></div>
</span></font>
<font size=2 face="Times"><span style="font-size:7px;font-family:Times">
<div style="position:absolute;top:10097;left:139"><nobr>注8 でも，JDK 1.3.1の環境にくらべると20倍ほど遅いのですが．要するに元がとんでもなく遅かったのです．</nobr></div>
</span></font>
<font size=3 face="Times"><span style="font-size:10px;font-family:Times">
<div style="position:absolute;top:9060;left:51"><nobr>Rava  03.6.18  5:09 PM  ページ165</nobr></div>
</span></font>
<!-- t13063r5a0c13063e1736n11322u5l0m0k0 -->
</body>
</html>
